{
  "domain": "flashcard-app",
  "framework": "fasthtml-fastlite",
  "accumulated_from": [
    "anki-v23",
    "anki-v24",
    "anki-v26",
    "anki-v40"
  ],
  "updated": "2026-01-09",
  "meta_patterns": [
    {
      "name": "layered-build",
      "components": [
        "data-model",
        "crud-routes",
        "algorithm-routes",
        "test-suite"
      ],
      "description": "Foundation-first layering: dataclass -> database -> CRUD -> domain logic -> tests",
      "signal": 5,
      "campaigns": [
        "anki-v23",
        "anki-v24"
      ],
      "conditions": "Works when each layer has clear inputs/outputs and minimal coupling"
    },
    {
      "name": "fastlite-dataclass-sync",
      "components": [
        "python-dataclass",
        "sqlite-table",
        "fastlite-db.create"
      ],
      "description": "Dataclass defines both Python type and database schema via db.create(Class, pk=...)",
      "signal": 4,
      "campaigns": [
        "anki-v23",
        "anki-v24"
      ],
      "conditions": "Works when schema is simple; may not scale to complex relations"
    },
    {
      "name": "post-redirect-get",
      "components": [
        "POST-mutation",
        "303-redirect",
        "GET-confirmation"
      ],
      "description": "All state mutations use POST, redirect with 303 to GET route",
      "signal": 6,
      "campaigns": [
        "anki-v23",
        "anki-v24"
      ],
      "conditions": "Works for form-based web apps; prevents duplicate submissions"
    },
    {
      "name": "algorithm-state-in-model",
      "components": [
        "dataclass-fields",
        "algorithm-state"
      ],
      "description": "Algorithm state (interval, next_review) stored directly in entity dataclass",
      "signal": 4,
      "campaigns": [
        "anki-v23",
        "anki-v24"
      ],
      "conditions": "Works when algorithm state is per-entity; clean for simple algorithms"
    },
    {
      "name": "fastlite-dataclass-persistence",
      "components": [
        "#pattern/dataclass-fields",
        "#pattern/db-create-pk"
      ],
      "description": "Python dataclass defines schema; db.create(Class, pk='id') creates SQLite table",
      "occurrences": 2,
      "signal": "positive",
      "campaigns": [
        "anki-v26"
      ]
    },
    {
      "name": "post-redirect-get-303",
      "components": [
        "#pattern/post-route",
        "#pattern/redirect-303"
      ],
      "description": "POST routes use RedirectResponse(status_code=303) to prevent form resubmission",
      "occurrences": 3,
      "signal": "positive",
      "campaigns": [
        "anki-v26"
      ]
    },
    {
      "name": "fasthtml-app-structure",
      "components": [
        "#pattern/fast-app",
        "#pattern/rt-decorator"
      ],
      "description": "fast_app() returns (app, rt); rt decorator defines routes with type hints",
      "occurrences": 2,
      "signal": "positive",
      "campaigns": [
        "anki-v26"
      ]
    },
    {
      "name": "behavior-driven-tests",
      "components": [
        "#pattern/test-client",
        "#pattern/test-per-behavior"
      ],
      "description": "Tests organized by user behavior (create, list, delete, study) not by route",
      "occurrences": 2,
      "signal": "positive",
      "campaigns": [
        "anki-v26"
      ]
    },
    {
      "name": "transform-plus-isoformat",
      "components": [
        "db.create(transform=True)",
        "date.today().isoformat()"
      ],
      "description": "Two-part date handling: transform=True for storage/retrieval, isoformat() for query comparisons",
      "signal": 7,
      "occurrences": 4,
      "conditions": "Required when SQLite stores dates and code compares against current date",
      "failure_modes": [
        "date-string-mismatch if either part missing"
      ],
      "derived_from": [
        "date-string-mismatch prevention",
        "fastlite-dataclass-sync"
      ],
      "campaigns": [
        "anki-v40"
      ]
    },
    {
      "name": "test-first-deferred-import",
      "components": [
        "get_app_components()",
        "pytest fixtures",
        "try/except import"
      ],
      "description": "Tests written before implementation using deferred import to handle ImportError gracefully",
      "signal": 4,
      "occurrences": 1,
      "conditions": "Works for spec-first development; fixtures defer import until test runtime",
      "failure_modes": [
        "Confusing errors if defer pattern not explained in fixture"
      ],
      "campaigns": [
        "anki-v40"
      ]
    },
    {
      "name": "adapter-bridge-testing",
      "components": [
        "DBWrapper",
        "dual-API support"
      ],
      "description": "Adapter class bridges test expectations (db.delete(id)) with ORM API (db.delete(Class, id))",
      "signal": 3,
      "occurrences": 1,
      "conditions": "Useful when test assumptions differ from implementation reality",
      "failure_modes": [
        "Extra abstraction layer adds complexity"
      ],
      "campaigns": [
        "anki-v40"
      ]
    },
    {
      "name": "spec-build-verify-cycle",
      "components": [
        "001_test-spec",
        "002-004_build",
        "pytest verification"
      ],
      "description": "SPEC phase writes all tests upfront; BUILD phases implement to pass tests; each task verifies with pytest",
      "signal": 5,
      "occurrences": 1,
      "conditions": "Works when requirements are clear upfront; reduces scope creep",
      "failure_modes": [
        "Test assumptions may need adjustment during build"
      ],
      "campaigns": [
        "anki-v40"
      ]
    }
  ],
  "failure_modes": [
    {
      "name": "date-string-mismatch",
      "description": "SQLite stores Python date objects as ISO strings. Direct comparison fails.",
      "occurrences": 3,
      "impact_tokens": 429000,
      "prevention": "TWO-PART FIX: (1) Use db.create(Class, pk='id', transform=True) for storage/retrieval. (2) In query logic, compare with date.today().isoformat() not date.today() directly.",
      "mitigation": "If table already created without transform: compare with str(date.today()) or parse dates explicitly.",
      "symptom": "card.next_review <= date.today() returns unexpected results or fails silently",
      "campaigns": [
        "anki-v23",
        "anki-v35",
        "anki-v36"
      ],
      "resolved": [
        "anki-v24"
      ],
      "evolution": "v36 discovered transform=True alone insufficient - query comparisons also need isoformat()",
      "warn_for": [
        "data-model",
        "study-routes",
        "date-fields",
        "next_review",
        "db.create",
        "date-comparison"
      ]
    }
  ],
  "evolution": [
    {
      "from": "raw SQL queries",
      "to": "dataclass + fastlite",
      "reason": "Type-safe CRUD without SQL strings",
      "campaigns": [
        "anki-v23"
      ]
    },
    {
      "from": "parallel task routing",
      "to": "sequential task routing",
      "reason": "Knowledge flows forward; complex tasks benefit from prior context",
      "campaigns": [
        "anki-v23 -> anki-v24"
      ],
      "impact": "-32% tokens on complex tasks"
    },
    {
      "from": "raw-sqlite-queries",
      "to": "fastlite-orm",
      "reason": "Dataclass defines schema; ORM handles CRUD operations",
      "campaigns": [
        "anki-v26"
      ]
    },
    {
      "from": "date-string-mismatch failure mode",
      "to": "transform-plus-isoformat meta-pattern",
      "reason": "Codified prevention: transform=True alone insufficient, also need isoformat() in queries",
      "campaigns": [
        "anki-v36",
        "anki-v40"
      ]
    },
    {
      "from": "layered-build pattern",
      "to": "spec-build-verify-cycle pattern",
      "reason": "Added test-first phase before build layers; explicit verification gates",
      "campaigns": [
        "anki-v24",
        "anki-v40"
      ]
    }
  ],
  "verification_patterns": {
    "data-model": "python3 -c \"from main import Model; print(Model)\"",
    "routes": "uv run pytest test_app.py -k <route_prefix>",
    "full-suite": "uv run pytest test_app.py -v"
  }
}