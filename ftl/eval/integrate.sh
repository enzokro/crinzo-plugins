#!/usr/bin/env bash
set -e

# FTL Evaluation Harness - Learning Integration
# Creates FTL decision records from eval learnings
#
# Usage: ./integrate.sh L001

EVAL_DIR="$(cd "$(dirname "$0")" && pwd)"
DECISIONS_DIR="$EVAL_DIR/decisions"
CHRONICLE="$EVAL_DIR/chronicle.md"

learning_id=$1

if [ -z "$learning_id" ]; then
    echo "Usage: ./integrate.sh <learning-id>"
    echo "Example: ./integrate.sh L001"
    echo ""
    echo "Available learnings in chronicle:"
    grep -E "^\| L[0-9]+" "$CHRONICLE" 2>/dev/null || echo "  (none)"
    exit 1
fi

# Ensure decisions directory exists
mkdir -p "$DECISIONS_DIR"

# Check if learning already integrated
existing=$(find "$DECISIONS_DIR" -name "${learning_id}_*" -type f 2>/dev/null | head -1)
if [ -n "$existing" ]; then
    echo "Learning $learning_id already integrated:"
    ls -1 "$DECISIONS_DIR"/${learning_id}_* 2>/dev/null
    echo ""
    echo "To re-integrate, remove the existing file first."
    exit 1
fi

# Parse learning from chronicle
# Look for "Learning L001:" pattern (may have ** markdown bold)
learning_line=$(grep -n "Learning ${learning_id}" "$CHRONICLE" | head -1)

if [ -z "$learning_line" ]; then
    echo "Error: Learning $learning_id not found in chronicle"
    echo ""
    echo "Available learnings:"
    grep "Learning L[0-9]" "$CHRONICLE" 2>/dev/null | sed 's/^/  /' || echo "  (none)"
    exit 1
fi

# Extract the learning insight (text after "Learning LXXX: " or "**Learning LXXX**: ")
insight=$(echo "$learning_line" | sed "s/.*Learning ${learning_id}[*]*: //" | sed 's/^\*\*//' | sed 's/\*\*$//')

# Find the entry date (look backwards for ## date header)
line_num=$(echo "$learning_line" | cut -d: -f1)
entry_date=$(head -n "$line_num" "$CHRONICLE" | grep -E "^## [0-9]{4}-[0-9]{2}-[0-9]{2}:" | tail -1 | sed 's/## //' | cut -d: -f1)

# Generate slug from insight
slug=$(echo "$insight" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-' | cut -c1-40)

# Create decision record file
decision_file="$DECISIONS_DIR/${learning_id}_${slug}.md"

cat > "$decision_file" << EOF
# ${learning_id}: ${insight}

*Integrated: $(date '+%Y-%m-%d') | Source: chronicle.md*

---

## Question

$(echo "$insight" | sed 's/ > / vs /' | sed 's/^/How should FTL handle: /')

## Options Considered

1. Option A — *rejected* (evidence showed failure)
2. Option B — **chosen** (evidence showed success)

## Decision

$(echo "$insight" | sed 's/.*> //')

## Rationale

This learning emerged from evaluation runs documented in the chronicle.
See chronicle entry: ${entry_date}

## Evidence

- Source: ftl/eval/chronicle.md
- Entry: ${entry_date}

## Signal

+3 (verified experimentally)

---

## Tags

#pattern/eval-learning
#decision/protocol-design

---

*This decision record was auto-generated by integrate.sh. Edit to add details.*
EOF

echo "Created: $decision_file"
echo ""
cat "$decision_file"
echo ""
echo "─────────────────────────────────────────"
echo "Edit the file to:"
echo "  1. Clarify the Question"
echo "  2. Specify Options Considered with reasons"
echo "  3. Add Evidence links"
echo "  4. Adjust Signal if needed"
echo ""
echo "To update chronicle index, mark as integrated:"
echo "  Edit chronicle.md, change 'pending' to 'yes' for $learning_id"
